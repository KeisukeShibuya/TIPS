# IAM「普段使いユーザー（管理作業用）」の権限設計メモ（学習用 / CDK+CLI前提）

前提：
- 普段の作業はルートユーザーではなく IAMユーザー（またはSSO）で行う
- CDK（CloudFormation）でデプロイまで実施する
- CLI（aws / cdk）も使用する
- 課金事故を避ける意識はあるが、特定サービスの一律禁止まではしない（必要なら後から可能）

---

## 1. 大原則（最重要）

### 1.1 ルートユーザーは封印（請求・アカウント系だけ）
ルートでやる（ルート必須/推奨が多い）：
- 支払い方法、請求に関する根幹設定
- アカウント全体の超重要設定（状況によりルート必須がある）

普段の運用/学習は IAMユーザー（またはロール）で行う。

### 1.2 可能なら IAM Identity Center（SSO）も検討
- 長期的に「アクセスキー管理」「MFA」「権限付与/剥奪」が楽
- ただし、ここではIAMユーザー前提の案を記載

---

## 2. 結論：普段使いユーザーに付ける権限（おすすめ順）

### 2.1 おすすめ（学習が詰まりにくい）：AdministratorAccess（運用ルール込み）
理由：
- CDK（= CloudFormation）経由のデプロイでは IAMロール/ポリシー作成が絡みやすい
- 最小権限で始めると序盤に詰まりやすい（学習が止まりがち）

付与するAWS管理ポリシー：
- AdministratorAccess

#### 事故りにくくする運用ルール（権限以上に効く）
- IAMユーザーにMFAを必ず設定
- リージョンを東京に固定（コンソールだけでなくCLIも）
  - 環境変数：AWS_REGION / AWS_DEFAULT_REGION を ap-northeast-1 にする
  - もしくは ~/.aws/config に region=ap-northeast-1 を設定
- CDKは「作ったら片付け」を徹底
  - 基本：cdk destroy で一括削除
- 予算（Budgets）/アラートは先に設定しておく

> 学習初期は AdministratorAccess で走り切り、慣れたら権限を絞るのが最短・低ストレス。

---

### 2.2 次点（IAMを壊したくない）：PowerUserAccess + デプロイ専用ロールへ昇格
考え方：
- 普段使いユーザーは強すぎない権限（PowerUser）にする
- CDKデプロイ時だけ「デプロイ専用ロール」にAssumeRoleして実行

構成イメージ：
- 普段使いユーザー：PowerUserAccess（必要ならIAM閲覧も追加）
- デプロイ専用ロール：AdministratorAccess（将来ここを最小化）
- 普段使いユーザーに sts:AssumeRole を許可して、デプロイ時にロールを切り替える

注意：
- 最初のセットアップがやや手間。学習初期は 2.1 が楽。

---

## 3. 「特定サービスを禁止したくなったら？」（後から追加可能）

ポイント：
- 「Allow（許可）で頑張る」より「Deny（拒否）で止める」方が強い
- Deny は AdministratorAccess よりも優先して効く

### 3.1 単体アカウントでもできる：IAMポリシーで明示的Deny
例：NAT Gateway や Transit Gateway の作成を禁止するポリシー（ユーザー/ロールに追加）
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyNatGateway",
      "Effect": "Deny",
      "Action": [
        "ec2:CreateNatGateway",
        "ec2:CreateTransitGateway"
      ],
    "Resource": "*"
    }
  ]
}
```
運用のコツ：
- 「EC2全部禁止」などの大雑把な禁止は学習が止まりやすい
- 高額化しやすい“作成系アクション”を狙ってDenyするのが現実的

### 3.2 組織運用なら最強：Organizations の SCP
- 複数アカウント運用や将来的な分離に強い
- ただし導入準備が増えるため、学習初期の単体アカウントでは必須ではない

---

## 4. 実務的まとめ（この通りでOK）

推奨：
- 普段使いユーザー：AdministratorAccess
- 併せて：
  - MFA必須
  - 東京リージョン固定（CLI含む）
  - Budgets/アラート
  - 片付けは cdk destroy

将来：
- 「これは触らない/高額化しやすい」サービスや機能が出たら、明示的Denyポリシーを追加してガードする

---

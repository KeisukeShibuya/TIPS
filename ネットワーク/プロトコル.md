# 目次

- [DHCP](#dhcp)
    - [概要](#概要)
    - [仕組み（DORA-4段階）](#仕組みdora-4段階)
    - [主要要素](#主要要素)
    - [DHCP中継（dhcp-relayagent）](#dhcp中継dhcp-relayagent)
    - [ポートトランスポート](#ポートトランスポート)
    - [セキュリティ考慮](#セキュリティ考慮)
    - [IPv6との違い](#ipv6との違い)
    - [よくあるトラブル](#よくあるトラブル)
    - [運用ベストプラクティス](#運用ベストプラクティス)
- [NAT／NAPT](#natnapt)
    - [概要](#概要-1)
    - [目的](#目的)
    - [NATの種類](#natの種類)
    - [動作例（NAPTの場合）](#動作例naptの場合)
    - [注意点・制限事項](#注意点制限事項)
    - [セキュリティ面](#セキュリティ面)
    - [IPv6との関係](#ipv6との関係)
    - [よくある運用・設定例](#よくある運用設定例)
    - [運用ベストプラクティス](#運用ベストプラクティス-1)
 - [HTTP/HTTPS](#httphttps)
     - [概要](#概要-2)
     - [仕組み](#仕組み)
     - [主要ヘッダ](#主要ヘッダ)
     - [HTTPS/TLS](#httpstls)
     - [ポート/トランスポート](#ポートトランスポート-1)
     - [セキュリティ考慮](#セキュリティ考慮-1)
 - [FTP](#ftp)
     - [概要](#概要-3)
     - [動作モード（アクティブ/パッシブ）](#動作モードアクティブパッシブ)
     - [ポート/トランスポート](#ポートトランスポート-2)
     - [セキュリティと代替プロトコル](#セキュリティと代替プロトコル)
 - [TCP/IP/UDP](#tcpipudp)
     - [概要](#概要-4)
     - [TCPの特徴](#tcpの特徴)
     - [UDPの特徴](#udpの特徴)
     - [よくあるトラブルと診断](#よくあるトラブルと診断)

# DHCP

## 概要
DHCP（Dynamic Host Configuration Protocol）は、**ネットワーク機器にIPアドレスやサブネットマスク、デフォルトゲートウェイ、DNSサーバーなどの設定を自動配布するプロトコル**です。これにより、手動での設定作業を削減し、設定ミスやアドレス重複といったトラブルを防止します。

---

## 仕組み（DORA 4段階）
1. **Discover**  
   クライアントがブロードキャストでDHCPサーバーを探索。
2. **Offer**  
   サーバーが構成情報とともに、使用可能なIPアドレスを提示。
3. **Request**  
   クライアントが選んだIPアドレスを要求。
4. **Acknowledge**  
   サーバーが要求を了承し、リース情報を付与して設定を確定。

---

## 主要要素
- **リース**  
  IPを一定期間貸与（有効期限あり）。リース期間の半分の時点で更新（T1/T2タイマー）。
- **スコープ／プール**  
  割り当て可能なIPの範囲。
- **予約**  
  特定MACアドレスに固定IPアドレスを常に割り当て。
- **オプション**  
  例：3=デフォルトゲートウェイ、6=DNSサーバー、15=ドメイン名、42=NTPサーバー、66/67=TFTPサーバー など。

---

## DHCP中継（DHCP Relay/Agent）
- ルーターなどを越えて、ネットワーク外のDHCPサーバーへブロードキャストパケットを中継（UDP 67/68）。
- サーバー集約やネットワーク分割時に有効。

---

## ポート/トランスポート
- **UDP 67** … サーバー側
- **UDP 68** … クライアント側
- 通信にはブロードキャストを多用

---

## セキュリティ考慮
- **不正DHCP対策**  
  DHCP Snooping、信頼ポート・不信頼ポートの使い分け、動的ARP検査（DAI）等と併用。
- **予約・認証**  
  802.1X・MACフィルタと併用するとより堅牢。DHCP自体には強力な認証機能は無し。

---

## IPv6との違い
- **DHCPv6**（UDP 546/547）が利用される。
- **SLAAC**と併用可能。
- アドレス配布まで行う「Stateful」と、オプション情報のみ配る「Stateless」がある。

---

## よくあるトラブル
- アドレス枯渇（プール不足）
- 複数DHCPサーバーの混在
- VLAN間でリレー未設定
- システム時刻ズレによるリース誤作動
- ブロードキャスト遮断
- クライアントが `169.254.x.x`（APIPA）となった場合は、サーバー到達不可やプール不足の可能性

---

## 運用ベストプラクティス
- ピーク同時接続＋αを見込んでスコープを設計
- 予約（マックアドレス公開）はサーバー側で一元管理（手動固定IPは最小化）
- ACLや防火壁でUDP 67/68の許可、リレー設定
- スイッチでDHCP Snooping有効化、信頼ポートは正規サーバー側のみに限定
- ログ・リース監視、リース期限調整（短期滞在ネットワークは短めのリースを推奨）

# NAT／NAPT

## 概要
**NAT（Network Address Translation）** は、プライベートIPアドレスとグローバルIPアドレスを相互変換する技術です。  
**NAPT（Network Address Port Translation／PAT：Port Address Translation）** は、NATにポート番号変換を加え、1つまたは少数のグローバルIPで多数の機器が同時通信できるようにします。

---

## 目的
- グローバルIPアドレス節約（IPv4アドレス不足への対応）
- 内部ネットワークのアドレス隠蔽とセキュリティ向上
- 同じプライベートIP体系を持つ複数拠点のネットワーク接続

---

## NATの種類
- **スタティックNAT（静的NAT）**  
  1対1で固定変換。公開サーバー配置時などに使用。
- **ダイナミックNAT（動的NAT）**  
  プールから未使用のグローバルIPを一時的に割り当てる。1対1だが自動変換。
- **NAPT（PAT/ポート多重化NAT）**  
  1つのグローバルIPに複数のプライベートIPをポート番号で多重化。現在最も一般的。（例: 家庭用ルータ）

---

## 動作例（NAPTの場合）
1. **内部機器**から送信（プライベートIP:192.168.1.2:12345 → 宛先8.8.8.8:80）
2. **ルータがグローバルIP:203.0.113.10:40001へ**変換して外部へ送信
3. **応答パケット**はグローバルIP:203.0.113.10:40001に届き、ルータが変換テーブルを参照し、元の内部機器へ転送

---

## 注意点・制限事項
- **セッション管理が必要**：変換テーブルが枯渇すると新規通信不可
- **IPsecや一部VoIP等プロトコルで問題**（ヘッダ内部でIP情報参照時）
- **グローバル側から内部への通信（サーバ公開）にはポートフォワーディング（静的変換）が必要**
- **同一グローバルIP／同一ポート番号では多重通信不可**（既存セッションが優先）

---

## セキュリティ面
- **内部アドレスが外部へ非公開**となり、不特定多数からの直接攻撃を低減
- **ファイアウォール動作の一部機能も担う**（ステートフルなパケット通過のみ許可）
- **NAT越え**：外部から内部への通信が不可（どうしても必要ならUPnP, DMZ, 静的ポート変換等）

---

## IPv6との関係
- **IPv6は原則NAT不要**（アドレス空間が膨大なため）
- ただし、企業・一部環境ではセグメント分離・アドレス秘匿のため利用例あり（NPTv6）

---

## よくある運用・設定例
- **インターネット接続用ルータ・FWでNAPT有効化**（デフォルトで有効な場合が多い）
- **サーバ公開はポートフォワーディング設定（NAT静的変換）**
- **NAPT変換テーブルの監視・クリア**（高負荷/大規模環境で重要）

---

## 運用ベストプラクティス
- サーバ公開時は不要なポートを開放しない
- ルータ/ファイアウォール機器のファームウェア最新化
- NATテーブルの容量監視、必要に応じリロード・拡張
- 通信障害時は「ポート枯渇」「NATテーブル溢れ」を疑う
- IPv6導入環境では、どこまでNATを使うか方針策定

---

# HTTP/HTTPS

## 概要
HTTP（HyperText Transfer Protocol）は、クライアントとサーバ間でリクエスト/レスポンスによりリソースをやり取りするアプリケーション層プロトコル。ステートレス設計だが、Cookie/セッション/トークン等で状態管理を拡張可能。主なバージョンは HTTP/1.1、HTTP/2、HTTP/3（QUIC）。

---

## 仕組み
1. クライアントがメソッド（GET, POST, PUT, DELETE など）とパス、ヘッダ、必要に応じボディを送信。
2. サーバはステータスコード（200, 301, 404, 500 など）、ヘッダ、ボディで応答。
3. 接続管理はバージョン依存：
   - HTTP/1.1: Keep-Alive によりパイプライン/持続的接続
   - HTTP/2: 1本のTCP上で多重化、ヘッダ圧縮（HPACK）
   - HTTP/3: UDP/QUIC上で多重化、0-RTT、ヘッダ圧縮（QPACK）

---

## 主要ヘッダ
- Host, User-Agent, Accept, Content-Type, Content-Length
- Authorization, Cookie, Set-Cookie, Cache-Control, ETag, Location, Referer, Origin, Access-Control-Allow-*（CORS）

---

## HTTPS/TLS
- HTTPS は HTTP を TLS で暗号化したもの。
- サーバ証明書でサーバ真正性を検証。SNI/ALPN で仮想ホストやプロトコル選択。
- TLSバージョンは 1.2/1.3 が主流。1.0/1.1 は非推奨。

---

## ポート/トランスポート
- 既定ポート: HTTP 80/TCP, HTTPS 443/TCP
- HTTP/3 は 443/UDP（QUIC）

---

## セキュリティ考慮
- 強制HTTPS（HSTS）、最新TLS、弱暗号スイート無効化
- Cookie に HttpOnly/Secure/SameSite
- 入力検証・CSRF対策、CORSの最小権限設定
- 証明書管理（有効期限、自動更新、OCSP Stapling）

---

# FTP

## 概要
FTP（File Transfer Protocol）は、クライアント/サーバ間でファイルを転送するためのプロトコル。制御接続とデータ接続の2本を使うのが特徴。

---

## 動作モード（アクティブ/パッシブ）
- アクティブ（PORT）: クライアント→サーバへ制御（21/TCP）。サーバ→クライアントへデータ接続（20/TCP発、クライアントの指定ポート）。FW/NAT越えで問題になりやすい。
- パッシブ（PASV）: 制御は21/TCP。データ接続はクライアント→サーバの待受ポート（サーバ側で動的ポート範囲を開放）。インターネット越しやNAT環境で一般的。

---

## ポート/トランスポート
- 制御: 21/TCP
- データ: 20/TCP（アクティブ時の送信用）または サーバが通知する高番ポート（パッシブ）

---

## セキュリティと代替プロトコル
- 平文FTPは認証情報/内容が盗聴されるため非推奨。
- FTPS（FTP over TLS）や SFTP（SSH File Transfer Protocol, 22/TCP）を推奨。
- アプリやFWでは「FTP ALG」を有効にすると動的ポートの追随が可能。

---

# TCP/IP/UDP

## 概要
TCP/IP はインターネットの基盤となるプロトコル群（IP層+トランスポート層+上位）。トランスポート層の代表が TCP と UDP。

---

## TCPの特徴
- コネクション型（3ウェイハンドシェイク: SYN→SYN/ACK→ACK）
- 信頼性（順序制御、再送制御、フロー制御、輻輳制御）
- セッション終了は FIN/ACK、RST で強制終了
- 代表的な上位: HTTP/1.1/2、SMTP、IMAP、SSH、TLSなど

---

## UDPの特徴
- コネクションレス、軽量、低遅延。再送や順序保証はアプリ層で必要。
- マルチキャスト/ブロードキャストに適する。
- 代表的な上位: DNS、DHCP、NTP、VoIP、QUIC（HTTP/3）など

---

## よくあるトラブルと診断
- TCP 接続不可: 三者間の到達性（ルーティング/ACL/FW）、リスン状態、SYN フラグ観測
- パフォーマンス低下: 輻輳ウィンドウ、RTT、ウィンドウスケーリング、MSS/MTU不一致（PMTUD, DFビット）
- UDP 到達性: 片方向遮断、NAT越え、フラグメント喪失
- 診断コマンド: ping（ICMP）, traceroute, netstat/ss, tcpdump/Wireshark, iperf

---
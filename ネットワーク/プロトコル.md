# 目次

- [DHCP](#dhcp)
    - [概要](#概要)
    - [仕組み（DORA-4段階）](#仕組みdora-4段階)
    - [主要要素](#主要要素)
    - [DHCP中継（dhcp-relayagent）](#dhcp中継dhcp-relayagent)
    - [ポートトランスポート](#ポートトランスポート)
    - [セキュリティ考慮](#セキュリティ考慮)
    - [IPv6との違い](#ipv6との違い)
    - [よくあるトラブル](#よくあるトラブル)
    - [運用ベストプラクティス](#運用ベストプラクティス)
- [NAT／NAPT](#natnapt)
    - [概要](#概要-1)
    - [目的](#目的)
    - [NATの種類](#natの種類)
    - [動作例（NAPTの場合）](#動作例naptの場合)
    - [注意点・制限事項](#注意点制限事項)
    - [セキュリティ面](#セキュリティ面)
    - [IPv6との関係](#ipv6との関係)
    - [よくある運用・設定例](#よくある運用設定例)
    - [運用ベストプラクティス](#運用ベストプラクティス-1)

# DHCP

## 概要
DHCP（Dynamic Host Configuration Protocol）は、**ネットワーク機器にIPアドレスやサブネットマスク、デフォルトゲートウェイ、DNSサーバーなどの設定を自動配布するプロトコル**です。これにより、手動での設定作業を削減し、設定ミスやアドレス重複といったトラブルを防止します。

---

## 仕組み（DORA 4段階）
1. **Discover**  
   クライアントがブロードキャストでDHCPサーバーを探索。
2. **Offer**  
   サーバーが構成情報とともに、使用可能なIPアドレスを提示。
3. **Request**  
   クライアントが選んだIPアドレスを要求。
4. **Acknowledge**  
   サーバーが要求を了承し、リース情報を付与して設定を確定。

---

## 主要要素
- **リース**  
  IPを一定期間貸与（有効期限あり）。リース期間の半分の時点で更新（T1/T2タイマー）。
- **スコープ／プール**  
  割り当て可能なIPの範囲。
- **予約**  
  特定MACアドレスに固定IPアドレスを常に割り当て。
- **オプション**  
  例：3=デフォルトゲートウェイ、6=DNSサーバー、15=ドメイン名、42=NTPサーバー、66/67=TFTPサーバー など。

---

## DHCP中継（DHCP Relay/Agent）
- ルーターなどを越えて、ネットワーク外のDHCPサーバーへブロードキャストパケットを中継（UDP 67/68）。
- サーバー集約やネットワーク分割時に有効。

---

## ポート/トランスポート
- **UDP 67** … サーバー側
- **UDP 68** … クライアント側
- 通信にはブロードキャストを多用

---

## セキュリティ考慮
- **不正DHCP対策**  
  DHCP Snooping、信頼ポート・不信頼ポートの使い分け、動的ARP検査（DAI）等と併用。
- **予約・認証**  
  802.1X・MACフィルタと併用するとより堅牢。DHCP自体には強力な認証機能は無し。

---

## IPv6との違い
- **DHCPv6**（UDP 546/547）が利用される。
- **SLAAC**と併用可能。
- アドレス配布まで行う「Stateful」と、オプション情報のみ配る「Stateless」がある。

---

## よくあるトラブル
- アドレス枯渇（プール不足）
- 複数DHCPサーバーの混在
- VLAN間でリレー未設定
- システム時刻ズレによるリース誤作動
- ブロードキャスト遮断
- クライアントが `169.254.x.x`（APIPA）となった場合は、サーバー到達不可やプール不足の可能性

---

## 運用ベストプラクティス
- ピーク同時接続＋αを見込んでスコープを設計
- 予約（マックアドレス公開）はサーバー側で一元管理（手動固定IPは最小化）
- ACLや防火壁でUDP 67/68の許可、リレー設定
- スイッチでDHCP Snooping有効化、信頼ポートは正規サーバー側のみに限定
- ログ・リース監視、リース期限調整（短期滞在ネットワークは短めのリースを推奨）

# NAT／NAPT

## 概要
**NAT（Network Address Translation）** は、プライベートIPアドレスとグローバルIPアドレスを相互変換する技術です。  
**NAPT（Network Address Port Translation／PAT：Port Address Translation）** は、NATにポート番号変換を加え、1つまたは少数のグローバルIPで多数の機器が同時通信できるようにします。

---

## 目的
- グローバルIPアドレス節約（IPv4アドレス不足への対応）
- 内部ネットワークのアドレス隠蔽とセキュリティ向上
- 同じプライベートIP体系を持つ複数拠点のネットワーク接続

---

## NATの種類
- **スタティックNAT（静的NAT）**  
  1対1で固定変換。公開サーバー配置時などに使用。
- **ダイナミックNAT（動的NAT）**  
  プールから未使用のグローバルIPを一時的に割り当てる。1対1だが自動変換。
- **NAPT（PAT/ポート多重化NAT）**  
  1つのグローバルIPに複数のプライベートIPをポート番号で多重化。現在最も一般的。（例: 家庭用ルータ）

---

## 動作例（NAPTの場合）
1. **内部機器**から送信（プライベートIP:192.168.1.2:12345 → 宛先8.8.8.8:80）
2. **ルータがグローバルIP:203.0.113.10:40001へ**変換して外部へ送信
3. **応答パケット**はグローバルIP:203.0.113.10:40001に届き、ルータが変換テーブルを参照し、元の内部機器へ転送

---

## 注意点・制限事項
- **セッション管理が必要**：変換テーブルが枯渇すると新規通信不可
- **IPsecや一部VoIP等プロトコルで問題**（ヘッダ内部でIP情報参照時）
- **グローバル側から内部への通信（サーバ公開）にはポートフォワーディング（静的変換）が必要**
- **同一グローバルIP／同一ポート番号では多重通信不可**（既存セッションが優先）

---

## セキュリティ面
- **内部アドレスが外部へ非公開**となり、不特定多数からの直接攻撃を低減
- **ファイアウォール動作の一部機能も担う**（ステートフルなパケット通過のみ許可）
- **NAT越え**：外部から内部への通信が不可（どうしても必要ならUPnP, DMZ, 静的ポート変換等）

---

## IPv6との関係
- **IPv6は原則NAT不要**（アドレス空間が膨大なため）
- ただし、企業・一部環境ではセグメント分離・アドレス秘匿のため利用例あり（NPTv6）

---

## よくある運用・設定例
- **インターネット接続用ルータ・FWでNAPT有効化**（デフォルトで有効な場合が多い）
- **サーバ公開はポートフォワーディング設定（NAT静的変換）**
- **NAPT変換テーブルの監視・クリア**（高負荷/大規模環境で重要）

---

## 運用ベストプラクティス
- サーバ公開時は不要なポートを開放しない
- ルータ/ファイアウォール機器のファームウェア最新化
- NATテーブルの容量監視、必要に応じリロード・拡張
- 通信障害時は「ポート枯渇」「NATテーブル溢れ」を疑う
- IPv6導入環境では、どこまでNATを使うか方針策定

---
# Spring Securityにおけるユーザデータの管理

1. **ユーザデータの管理方法について**  
Spring Securityを利用する場合、ユーザデータや権限情報をRDB（MySQL等）で管理するのが一般的です。インメモリ管理は開発やテスト用途に適しており、本番運用ではRDB管理が推奨されます。

2. **`SecurityConfig`の修正方法と追加クラスについて**  
RDBでユーザ管理する場合、`UserDetailsService`の実装を自作し、DBからユーザ情報を取得する必要があります。  
主な修正・追加点は以下の通りです。

---

**① ユーザ・権限テーブルの用意（例）**

```sql
-- db/schema.sql
CREATE TABLE users (
  username VARCHAR(50) PRIMARY KEY,
  password VARCHAR(100) NOT NULL,
  enabled BOOLEAN NOT NULL
);

CREATE TABLE authorities (
  username VARCHAR(50),
  authority VARCHAR(50),
  FOREIGN KEY (username) REFERENCES users(username)
);
```

---

**② `UserDetailsService`の実装クラスを作成**

```java
// src/main/java/com/example/demo/service/CustomUserDetailsService.java
package com.example.demo.service;

import org.springframework.security.core.userdetails.*;
import org.springframework.stereotype.Service;
import org.springframework.beans.factory.annotation.Autowired;
import com.example.demo.mapper.UserMapper;
import com.example.demo.model.User;

@Service
public class CustomUserDetailsService implements UserDetailsService {
    @Autowired
    private UserMapper userMapper;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        User user = userMapper.findByUsername(username);
        if (user == null) throw new UsernameNotFoundException("User not found");
        return user;
    }
}
```

---

**③ `UserDetails`を実装したエンティティクラス**

```java
// src/main/java/com/example/demo/model/User.java
package com.example.demo.model;

import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import java.util.*;

public class User implements UserDetails {
    private String username;
    private String password;
    private boolean enabled;
    private List<GrantedAuthority> authorities;

    // getter, setter, UserDetailsのメソッド実装
}
```

---

**④ MyBatis等でDBアクセスするMapperインターフェース**

```java
// src/main/java/com/example/demo/mapper/UserMapper.java
package com.example.demo.mapper;

import com.example.demo.model.User;
import org.apache.ibatis.annotations.Mapper;

@Mapper
public interface UserMapper {
    User findByUsername(String username);
}
```

---

**⑤ `SecurityConfig`の修正**

```java
// src/main/java/com/example/demo/config/SecurityConfig.java
@Bean
public UserDetailsService userDetailsService() {
    return new CustomUserDetailsService();
}
```
または、`@Autowired`でDIするだけでもOKです。

---

**まとめ**  
- RDB管理が一般的  
- `UserDetailsService`の自作実装が必要  
- ユーザ・権限テーブル、エンティティ、Mapper等の追加が必要  
- `SecurityConfig`で自作サービスを利用するよう修正

この構成で、DB連携のSpring Securityログインが実現できます。